<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示词优化管理系统 - 简仪科技锐视测控平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .mode-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .mode-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .mode-card.active {
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .mode-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }

        .mode-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .mode-card .description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .difficulty {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .difficulty-stars {
            color: #f39c12;
        }

        .features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feature-tag {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .template-editor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .editor-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .toolbar-btn:hover {
            background: #5a6268;
        }

        .preview-panel {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .json-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }

        .json-validation {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .validation-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .validation-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .metric-trend {
            margin-top: 5px;
            font-size: 0.8em;
        }

        .metric-trend.up {
            color: #27ae60;
        }

        .metric-trend.down {
            color: #e74c3c;
        }

        .suggestion-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .confidence-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .impact-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .suggestion-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .layer-architecture {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        .layer-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #3498db;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .layer-components {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .component-tag {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.9em;
        }

        .inheritance-arrow {
            text-align: center;
            font-size: 1.5em;
            color: #7f8c8d;
            margin: 10px 0;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .template-editor {
                grid-template-columns: 1fr;
            }
            
            .mode-cards {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>
                🧠 提示词优化管理系统
            </h1>
            <div class="subtitle">
                简仪科技锐视测控平台 - 智能提示词管理与优化解决方案
            </div>
        </div>

        <!-- 模式选择器 -->
        <div class="mode-selector">
            <h2>选择管理模式</h2>
            <div class="mode-cards" id="modeCards">
                <!-- 模式卡片将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="main-content">
            <!-- 简单模式 -->
            <div class="mode-content" id="simpleMode">
                <h2>🚀 简单模式 - 快速配置</h2>
                <div class="form-group">
                    <label>公司名称</label>
                    <input type="text" id="companyName" value="简仪科技" />
                </div>
                <div class="form-group">
                    <label>主要产品</label>
                    <input type="text" id="mainProduct" value="锐视测控平台" />
                </div>
                <div class="form-group">
                    <label>回答风格</label>
                    <select id="responseStyle">
                        <option value="professional">专业技术型</option>
                        <option value="friendly">友好解释型</option>
                        <option value="detailed">详细教学型</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>重点领域</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="pxi" checked />
                            <label for="pxi">PXI系统</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="daq" checked />
                            <label for="daq">数据采集</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="signal" />
                            <label for="signal">信号处理</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="education" />
                            <label for="education">教育培训</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="generateSimplePrompt()">
                    ✨ 一键生成提示词
                </button>
            </div>

            <!-- 模板模式 -->
            <div class="mode-content" id="templateMode">
                <h2>📝 模板模式 - 可视化编辑</h2>
                <div class="form-group">
                    <label>模板分类</label>
                    <select id="templateCategory">
                        <option value="company">公司介绍</option>
                        <option value="product">产品推荐</option>
                        <option value="support">技术支持</option>
                        <option value="education">教育培训</option>
                    </select>
                </div>
                <div class="template-editor">
                    <div class="editor-panel">
                        <h3>模板编辑器</h3>
                        <div class="editor-toolbar">
                            <button class="toolbar-btn" onclick="insertVariable('{question}')">插入问题</button>
                            <button class="toolbar-btn" onclick="insertVariable('{knowledge_content}')">插入知识库</button>
                            <button class="toolbar-btn" onclick="insertVariable('{company_name}')">插入公司名</button>
                            <button class="toolbar-btn" onclick="insertVariable('{product_name}')">插入产品名</button>
                        </div>
                        <textarea id="templateContent" rows="15" placeholder="在此编辑模板内容...">你是{company_name}的专业AI助手。

{knowledge_content}

用户问题：{question}

请基于我们的技术优势，提供专业准确的回答。</textarea>
                    </div>
                    <div class="editor-panel">
                        <h3>实时预览</h3>
                        <div class="preview-panel" id="templatePreview">
                            预览内容将在这里显示...
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveTemplate()">
                    💾 保存模板
                </button>
                <button class="btn" onclick="previewTemplate()">
                    👁️ 更新预览
                </button>
            </div>

            <!-- JSON模式 -->
            <div class="mode-content" id="jsonMode">
                <h2>⚙️ JSON模式 - 高级配置</h2>
                <div class="form-group">
                    <label>配置模板</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn" onclick="loadJsonTemplate('basic')">基础配置</button>
                        <button class="btn" onclick="loadJsonTemplate('advanced')">高级配置</button>
                        <button class="btn" onclick="loadJsonTemplate('multilingual')">多语言配置</button>
                    </div>
                </div>
                <textarea id="jsonConfig" class="json-editor" rows="20">{
  "prompt_system": {
    "version": "2.0",
    "default_language": "zh-CN",
    "fallback_strategy": "layered"
  },
  "templates": {
    "company_intro": {
      "priority": 1,
      "conditions": ["公司", "简仪科技", "JYTEK"],
      "content": "你是简仪科技的AI助手...",
      "variables": ["company_info", "product_list"],
      "ai_model_preference": "claude"
    }
  },
  "optimization": {
    "auto_learning": true,
    "feedback_threshold": 4.0,
    "update_frequency": "daily"
  }
}</textarea>
                <div class="json-validation">
                    <button class="btn" onclick="validateJson()">🔍 验证配置</button>
                    <button class="btn" onclick="previewJson()">👁️ 预览效果</button>
                    <button class="btn btn-success" onclick="saveJsonConfig()">💾 保存配置</button>
                </div>
                <div class="validation-result" id="jsonValidationResult"></div>
            </div>

            <!-- 智能模式 -->
            <div class="mode-content" id="intelligentMode">
                <h2>🧠 智能模式 - AI驱动优化</h2>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">4.2</div>
                        <div class="metric-label">用户满意度</div>
                        <div class="metric-trend up">↗ +0.3</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">78%</div>
                        <div class="metric-label">知识库利用率</div>
                        <div class="metric-trend up">↗ +12%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">85%</div>
                        <div class="metric-label">回答准确性</div>
                        <div class="metric-trend down">↘ -2%</div>
                    </div>
                </div>

                <h3>AI优化建议</h3>
                <div id="optimizationSuggestions">
                    <div class="suggestion-card">
                        <div class="suggestion-header">
                            <div>
                                <span class="confidence-badge">置信度: 92%</span>
                                <span class="impact-badge">预期提升: +15%</span>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            建议在技术支持类问题中增加具体的产品型号引用，可提高回答的实用性。
                        </div>
                        <div class="suggestion-actions">
                            <button class="btn btn-success">应用建议</button>
                            <button class="btn btn-warning">A/B测试</button>
                            <button class="btn">忽略</button>
                        </div>
                    </div>
                </div>

                <h3>意图分析测试</h3>
                <div class="form-group">
                    <label>测试问题</label>
                    <input type="text" id="intentTestQuestion" placeholder="输入问题进行意图分析..." />
                </div>
                <button class="btn" onclick="analyzeIntent()">🔍 分析意图</button>
                <div id="intentAnalysisResult" class="test-results" style="display: none;"></div>
            </div>

            <!-- 专家模式 -->
            <div class="mode-content" id="expertMode">
                <h2>🏗️ 专家模式 - 分层架构管理</h2>
                
                <div class="layer-architecture">
                    <div class="layer-card">
                        <div class="layer-header">
                            <h3>基础层 (Foundation)</h3>
                            <button class="btn" onclick="editLayer('foundation')">编辑基础层</button>
                        </div>
                        <p>公司核心信息，所有回答的基础</p>
                        <div class="layer-components">
                            <span class="component-tag">公司身份</span>
                            <span class="component-tag">核心价值观</span>
                            <span class="component-tag">回答原则</span>
                        </div>
                    </div>

                    <div class="inheritance-arrow">↓ 继承</div>

                    <div class="layer-card">
                        <div class="layer-header">
                            <h3>业务层 (Business)</h3>
                            <button class="btn" onclick="editLayer('business')">编辑业务层</button>
                        </div>
                        <p>场景特定的专业提示词</p>
                        <div class="layer-components">
                            <span class="component-tag">产品咨询</span>
                            <span class="component-tag">技术支持</span>
                            <span class="component-tag">教育培训</span>
                        </div>
                    </div>

                    <div class="inheritance-arrow">↓ 继承</div>

                    <div class="layer-card">
                        <div class="layer-header">
                            <h3>个性化层 (Personalization)</h3>
                            <button class="btn" onclick="editLayer('personalization')">编辑个性化层</button>
                        </div>
                        <p>用户自定义和偏好设置</p>
                        <div class="layer-components">
                            <span class="component-tag">用户偏好</span>
                            <span class="component-tag">行业定制</span>
                            <span class="component-tag">个人设置</span>
                        </div>
                    </div>
                </div>

                <h3>继承规则配置</h3>
                <div class="form-group">
                    <label>优先级策略</label>
                    <select id="priorityStrategy">
                        <option value="override">覆盖模式</option>
                        <option value="merge" selected>合并模式</option>
                        <option value="append">追加模式</option>
                    </select>
                </div>
            </div>

            <!-- 测试区域 -->
            <div class="test-section">
                <h3>🧪 提示词测试</h3>
                <div class="form-group">
                    <label>测试问题</label>
                    <input type="text" id="testQuestion" placeholder="输入问题测试提示词效果..." />
                </div>
                <button class="btn" onclick="testPrompt()">🚀 测试提示词</button>
                <div id="testResults" class="test-results" style="display: none;"></div>
            </div>

            <!-- 加载动画 -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>处理中，请稍候...</div>
            </div>

            <!-- 提示信息 -->
            <div class="alert" id="alertMessage"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentMode = 'simple';
        let userLevel = 'expert'; // 默认专家级别，可以访问所有模式

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableModes();
            switchMode('simple');
        });

        // 加载可用模式
        async function loadAvailableModes() {
            try {
                const response = await fetch(`/api/prompt/modes?user_level=${userLevel}`);
                const data = await response.json();
                
                if (data.success) {
                    renderModeCards(data.data.modes);
                } else {
                    showAlert('加载模式失败: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('网络错误: ' + error.message, 'error');
            }
        }

        // 渲染模式卡片
        function renderModeCards(modes) {
            const container = document.getElementById('modeCards');
            container.innerHTML = '';

            const modeIcons = {
                'simple': '🚀',
                'template': '📝',
                'json': '⚙️',
                'intelligent': '🧠',
                'expert': '🏗️'
            };

            for (const [key, mode] of Object.entries(modes)) {
                const card = document.createElement('div');
                card.className = 'mode-card';
                card.onclick = () => switchMode(key);
                
                const stars = '★'.repeat(mode.difficulty) + '☆'.repeat(5 - mode.difficulty);
                
                card.innerHTML = `
                    <div class="icon">${modeIcons[key] || '🔧'}</div>
                    <h3>${mode.name}</h3>
                    <div class="description">${mode.description}</div>
                    <div class="difficulty">
                        <span>难度: </span>
                        <span class="difficulty-stars">${stars}</span>
                    </div>
                    <div class="features">
                        ${mode.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                    </div>
                `;
                
                container.appendChild(card);
            }
        }

        // 切换模式
        function switchMode(mode) {
            // 更新当前模式
            currentMode = mode;
            
            // 更新模式卡片状态
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            event?.target?.closest('.mode-card')?.classList.add('active');
            
            // 显示对应的内容
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // 加载模式特定数据
            loadModeData(mode);
        }

        // 加载模式数据
        async function loadModeData(mode) {
            try {
                switch (mode) {
                    case 'simple':
                        await loadSimpleConfig();
                        break;
                    case 'template':
                        await loadTemplateCategories();
                        break;
                    case 'json':
                        await loadJsonConfig();
                        break;
                    case 'intelligent':
                        await loadOptimizationSuggestions();
                        break;
                    case 'expert':
                        await loadExpertLayers();
                        break;
                }
            } catch (error) {
                showAlert('加载模式数据失败: ' + error.message, 'error');
            }
        }

        // 简单模式相关函数
        async function loadSimpleConfig() {
            try {
                const response = await fetch('/api/prompt/simple/config');
                const data = await response.json();
                
                if (data.success) {
                    const config = data.data;
                    document.getElementById('companyName').value = config.company_name || '简仪科技';
                    document.getElementById('mainProduct').value = config.main_product || '锐视测控平台';
                    document.getElementById('responseStyle').value = config.response_style || 'professional';
                    
                    // 设置重点领域
                    const focusAreas = config.focus_areas || ['PXI系统', '数据采集'];
                    document.getElementById('pxi').checked = focusAreas.includes('PXI系统');
                    document.getElementById('daq').checked = focusAreas.includes('数据采集');
                    document.getElementById('signal').checked = focusAreas.includes('信号处理');
                    document.getElementById('education').checked = focusAreas.includes('教育培训');
                }
            } catch (error) {
                console.error('加载简单配置失败:', error);
            }
        }

        async function generateSimplePrompt() {
            try {
                showLoading(true);
                
                const config = {
                    company_name: document.getElementById('companyName').value,
                    main_product: document.getElementById('mainProduct').value,
                    response_style: document.getElementById('responseStyle').value,
                    focus_areas: []
                };
                
                // 收集重点领域
                if (document.getElementById('pxi').checked) config.focus_areas.push('PXI系统');
                if (document.getElementById('daq').checked) config.focus_areas.push('数据采集');
                if (document.getElementById('signal').checked) config.focus_areas.push('信号处理');
                if (document.getElementById('education').checked) config.focus_areas.push('教育培训');
                
                // 保存配置
                const saveResponse = await fetch('/api/prompt/simple/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
                
                const saveData = await saveResponse.json();
                if (saveData.success) {
                    showAlert('简单模式配置已保存并生效！', 'success');
                } else {
                    showAlert('保存配置失败: ' + saveData.error, 'error');
                }
                
            } catch (error) {
                showAlert('生成提示词失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 模板模式相关函数
        async function loadTemplateCategories() {
            try {
                const response = await fetch('/api/prompt/template/categories');
                const data = await response.json();
                
                if (data.success) {
                    // 模板分类已在HTML中预设
                    previewTemplate();
                }
            } catch (error) {
                console.error('加载模板分类失败:', error);
            }
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('templateContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + variable + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + variable.length, start + variable.length);
            
            previewTemplate();
        }

        function previewTemplate() {
            const content = document.getElementById('templateContent').value;
            const preview = document.getElementById('templatePreview');
            
            // 替换变量为示例值
            let previewContent = content
                .replace(/{company_name}/g, '简仪科技')
                .replace(/{product_name}/g, '锐视测控平台')
                .replace(/{question}/g, '请介绍一下PXI数据采集系统的特点')
                .replace(/{knowledge_content}/g, '相关知识库内容：\nPXI是一种基于PC的测量和自动化平台...');
            
            preview.textContent = previewContent;
        }

        async function saveTemplate() {
            try {
                showLoading(true);
                
                const category = document.getElementById('templateCategory').value;
                const content = document.getElementById('templateContent').value;
                const variables = ['question', 'knowledge_content', 'company_name', 'product_name'];
                
                const response = await fetch('/api/prompt/template/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category,
                        template_content: content,
                        variables
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('模板保存成功！', 'success');
                } else {
                    showAlert('保存模板失败: ' + data.error, 'error');
                }
                
            } catch (error) {
                showAlert('保存模板失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // JSON模式相关函数
        async function loadJsonConfig() {
            try {
                const response = await fetch('/api/prompt/json/config');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('jsonConfig').value = JSON.stringify(data.data, null, 2);
                }
            } catch (error) {
                console.error('加载JSON配置失败:', error);
            }
        }

        function loadJsonTemplate(type) {
            const templates = {
                basic: {
                    "prompt_system": {
                        "version": "2.0",
                        "default_language": "zh-CN"
                    },
                    "templates": {
                        "default": {
                            "content": "你是简仪科技的AI助手...",
                            "variables": ["question", "knowledge_content"]
                        }
                    }
                },
                advanced: {
                    "prompt_system": {
                        "version": "2.0",
                        "default_language": "zh-CN",
                        "fallback_strategy": "layered"
                    },
                    "templates": {
                        "company_intro": {
                            "priority": 1,
                            "conditions": ["公司", "简仪科技"],
                            "content": "你是简仪科技的AI助手...",
                            "variables": ["company_info", "product_list"]
                        },
                        "technical_support": {
                            "priority": 2,
                            "conditions": ["故障", "问题", "技术"],
                            "content": "作为技术支持专家...",
                            "ai_model_preference": "claude"
                        }
                    },
                    "optimization": {
                        "auto_learning": true,
                        "feedback_threshold": 4.0
                    }
                },
                multilingual: {
                    "prompt_system": {
                        "version": "2.0",
                        "default_language": "zh-CN",
                        "supported_languages": ["zh-CN", "en-US"]
                    },
                    "templates": {
                        "zh-CN": {
                            "company_intro": "你是简仪科技的AI助手...",
                            "variables": ["question", "knowledge_content"]
                        },
                        "en-US": {
                            "company_intro": "You are an AI assistant for JYTEK...",
                            "variables": ["question", "knowledge_content"]
                        }
                    }
                }
            };
            
            document.getElementById('jsonConfig').value = JSON.stringify(templates[type], null, 2);
        }

        async function validateJson() {
            try {
                const configText = document.getElementById('jsonConfig').value;
                const config = JSON.parse(configText);
                
                const response = await fetch('/api/prompt/json/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('jsonValidationResult');
                
                if (data.success && data.data.valid) {
                    resultDiv.className = 'validation-result success';
                    resultDiv.textContent = '✅ JSON配置格式正确';
                } else {
                    resultDiv.className = 'validation-result error';
                    resultDiv.textContent = '❌ 配置错误: ' + (data.data.errors?.join(', ') || '格式不正确');
                }
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                const resultDiv = document.getElementById('jsonValidationResult');
                resultDiv.className = 'validation-result error';
                resultDiv.textContent = '❌ JSON格式错误: ' + error.message;
                resultDiv.style.display = 'block';
            }
        }

        async function previewJson() {
            try {
                const configText = document.getElementById('jsonConfig').value;
                const config = JSON.parse(configText);
                
                const testQuestion = "请介绍简仪科技的主要产品";
                const response = await fetch('/api/prompt/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: testQuestion,
                        mode: 'json',
                        config: { json_config: config }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('预览提示词:\n\n' + data.data.prompt);
                } else {
                    showAlert('预览失败: ' + data.error, 'error');
                }
                
            } catch (error) {
                showAlert('预览失败: ' + error.message, 'error');
            }
        }

        async function saveJsonConfig() {
            try {
                showLoading(true);
                
                const configText = document.getElementById('jsonConfig').value;
                const config = JSON.parse(configText);
                
                const response = await fetch('/api/prompt/json/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config,
                        description: 'JSON配置更新',
                        author: 'admin'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('JSON配置保存成功！版本: ' + data.version_id, 'success');
                } else {
                    showAlert('保存配置失败: ' + data.error, 'error');
                }
                
            } catch (error) {
                showAlert('保存配置失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 智能模式相关函数
        async function loadOptimizationSuggestions() {
            try {
                const response = await fetch('/api/prompt/intelligent/optimizations');
                const data = await response.json();
                
                if (data.success) {
                    // 优化建议已在HTML中预设
                }
            } catch (error) {
                console.error('加载优化建议失败:', error);
            }
        }

        async function analyzeIntent() {
            try {
                const question = document.getElementById('intentTestQuestion').value;
                if (!question) {
                    showAlert('请输入测试问题', 'error');
                    return;
                }
                
                showLoading(true);
                
                const response = await fetch('/api/prompt/intelligent/analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                if (data.success) {
                    const result = data.data;
                    const resultDiv = document.getElementById('intentAnalysisResult');
                    
                    let html = `<h4>意图分析结果</h4>`;
                    html += `<p><strong>问题:</strong> ${result.question}</p>`;
                    html += `<p><strong>主要意图:</strong> ${result.primary_intent}</p>`;
                    html += `<h5>各意图置信度:</h5><ul>`;
                    
                    for (const [intent, score] of Object.entries(result.intent_scores)) {
                        const percentage = (score * 100).toFixed(1);
                        html += `<li>${intent}: ${percentage}%</li>`;
                    }
                    html += `</ul>`;
                    
                    resultDiv.innerHTML = html;
                    resultDiv.style.display = 'block';
                } else {
                    showAlert('意图分析失败: ' + data.error, 'error');
                }
                
            } catch (error) {
                showAlert('意图分析失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 专家模式相关函数
        async function loadExpertLayers() {
            try {
                const response = await fetch('/api/prompt/expert/layers');
                const data = await response.json();
                
                if (data.success) {
                    // 层级信息已在HTML中预设
                }
            } catch (error) {
                console.error('加载专家层级失败:', error);
            }
        }

        function editLayer(layerType) {
            alert(`编辑${layerType}层功能开发中...`);
        }

        // 通用测试函数
        async function testPrompt() {
            try {
                const question = document.getElementById('testQuestion').value;
                if (!question) {
                    showAlert('请输入测试问题', 'error');
                    return;
                }
                
                showLoading(true);
                
                const response = await fetch('/api/prompt/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        mode: currentMode,
                        config: {
                            knowledge_content: '这是测试知识库内容...',
                            user_preferences: {}
                        }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const result = data.data;
                    const resultDiv = document.getElementById('testResults');
                    
                    let html = `<h4>测试结果</h4>`;
                    html += `<p><strong>模式:</strong> ${result.mode}</p>`;
                    html += `<p><strong>问题:</strong> ${result.test_question}</p>`;
                    html += `<p><strong>提示词长度:</strong> ${result.analysis.length} 字符</p>`;
                    html += `<p><strong>预估Token:</strong> ${Math.round(result.analysis.estimated_tokens)}</p>`;
                    html += `<p><strong>复杂度评分:</strong> ${result.analysis.complexity_score.toFixed(2)}/5.0</p>`;
                    html += `<p><strong>包含知识库:</strong> ${result.analysis.has_knowledge_content ? '是' : '否'}</p>`;
                    html += `<h5>生成的提示词:</h5>`;
                    html += `<pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap;">${result.prompt}</pre>`;
                    
                    resultDiv.innerHTML = html;
                    resultDiv.style.display = 'block';
                } else {
                    showAlert('测试失败: ' + data.error, 'error');
                }
                
            } catch (error) {
                showAlert('测试失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 工具函数
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertMessage');
            alert.className = `alert ${type} show`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // 自动更新模板预览
        document.addEventListener('DOMContentLoaded', function() {
            const templateContent = document.getElementById('templateContent');
            if (templateContent) {
                templateContent.addEventListener('input', previewTemplate);
            }
        });
    </script>
</body>
</html>
